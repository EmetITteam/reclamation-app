<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Service Desk | Emet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border-top-color: #3B82F6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .required-mark::after { content: " *"; color: red; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col">

    <div id="login-screen" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center p-6">
        <div class="text-center w-full max-w-sm">
            <div class="bg-blue-100 p-4 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-user-doctor text-3xl text-blue-600"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">–í—Ö—ñ–¥ —É —Å–∏—Å—Ç–µ–º—É</h2>
            <p class="text-gray-500 mb-6">–í–≤–µ–¥—ñ—Ç—å –≤–∞—à–µ —ñ–º'—è –¥–ª—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó</p>
            <input type="text" id="login-name" class="w-full border border-gray-300 rounded-lg p-3 mb-4 text-center text-lg" placeholder="–ù–∞–ø—Ä–∏–∫–ª–∞–¥: –û–ª–µ–Ω–∞">
            <button onclick="loginUser()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow hover:bg-blue-700">–£–≤—ñ–π—Ç–∏</button>
        </div>
    </div>

    <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 shrink-0">
        <h1 class="text-lg font-bold text-blue-800 flex items-center gap-2">
            <i class="fa-solid fa-notes-medical"></i> EMET Service Desk
        </h1>
        <div class="text-xs text-right leading-tight">
            <div class="text-gray-400">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</div>
            <div class="font-bold text-gray-800" id="current-user-display">...</div>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-3 pb-24 no-scrollbar">

        <div id="tab-new" class="block">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <h2 class="text-lg font-semibold mb-4 text-gray-800 border-b pb-2">–ù–æ–≤–∞ —Ä–µ–∫–ª–∞–º–∞—Ü—ñ—è</h2>
                
                <form id="claimForm" onsubmit="submitForm(event)">
                    
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 required-mark">–¢–∏–ø –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è</label>
                        <select id="claimType" class="w-full bg-gray-50 border border-gray-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø...</option>
                            <option value="defect_pack">üì¶ –ë—Ä–∞–∫ —É–ø–∞–∫–æ–≤–∫–∏</option>
                            <option value="quality">üíé –Ø–∫—ñ—Å—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç—É</option>
                            <option value="effectiveness">üìâ –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</option>
                            <option value="side_effect">ü§í –ü–æ–±—ñ—á–Ω–∞ –¥—ñ—è</option>
                            <option value="complication">üöë –£—Å–∫–ª–∞–¥–Ω–µ–Ω–Ω—è</option>
                            <option value="other">üìù –Ü–Ω—à–µ</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 gap-3 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 required-mark">–ö–ª—ñ—î–Ω—Ç (–õ—ñ–∫–∞—Ä/–°–∞–ª–æ–Ω)</label>
                            <input type="text" id="client" class="w-full border border-gray-300 rounded-lg p-3 text-sm" placeholder="–ü–Ü–ë –ª—ñ–∫–∞—Ä—è" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 required-mark">‚Ññ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó</label>
                            <input type="text" id="invoice" class="w-full border border-gray-300 rounded-lg p-3 text-sm" placeholder="–ù–∞–ø—Ä: –†–ù-00123" required>
                        </div>
                    </div>

                    <div class="mb-5 bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <label class="block text-xs font-bold text-blue-800 uppercase mb-2 required-mark">–ü—Ä–µ–ø–∞—Ä–∞—Ç</label>
                        <select id="product" onchange="renderDynamicForm()" class="w-full bg-white border border-blue-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none" required>
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç...</option>
                            <option value="VITARAN">HP CELL VITARAN (–≤—Å—ñ)</option>
                            <option value="NEURONOX">NEURONOX</option>
                            <option value="NEURAMIS">NEURAMIS</option>
                            <option value="ELLANSE">ELLANSE</option>
                            <option value="PETARAN">PETARAN</option>
                            <option value="OTHER">–Ü–Ω—à–µ / –ö–æ—Å–º–µ—Ü–µ–≤—Ç–∏–∫–∞</option>
                        </select>
                        
                        <div class="mt-3 grid grid-cols-2 gap-2">
                            <input type="text" id="lot" class="w-full border border-gray-300 rounded-lg p-2 text-sm" placeholder="LOT / –°–µ—Ä—ñ—è" required>
                            <input type="date" id="date_proc" class="w-full border border-gray-300 rounded-lg p-2 text-sm text-gray-500" title="–î–∞—Ç–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏">
                        </div>
                    </div>

                    <div id="dynamic-form-area" class="hidden mb-5 border-t pt-4">
                        <h3 class="text-sm font-bold text-gray-700 mb-3"><i class="fa-solid fa-list-check mr-1"></i>–î–µ—Ç–∞–ª—ñ —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—É</h3>
                        <div id="dynamic-fields" class="space-y-3"></div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">–ú–µ–¥—ñ–∞ –¥–æ–∫–∞–∑–∏</label>
                        <label class="flex flex-col items-center justify-center w-full h-20 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                            <i class="fa-solid fa-camera text-gray-400 text-xl"></i>
                            <span class="text-xs text-gray-500 mt-1">–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ</span>
                            <input id="dropzone-file" type="file" class="hidden" multiple accept="image/*,video/*" onchange="previewFiles()" />
                        </label>
                        <div id="preview-area" class="flex gap-2 mt-2 overflow-x-auto p-1"></div>
                    </div>

                    <button type="submit" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-xl transition active:scale-95 flex justify-center items-center">
                        <span id="btn-text">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ä–µ–∫–ª–∞–º–∞—Ü—ñ—é</span>
                        <div id="btn-loader" class="loader ease-linear rounded-full border-2 border-t-2 border-white h-5 w-5 ml-2 hidden"></div>
                    </button>
                </form>
            </div>
        </div>

        <div id="tab-history" class="hidden">
            <h2 class="text-lg font-semibold mb-4 px-1">–ú–æ—ó –∑–∞—è–≤–∫–∏</h2>
            
            <div id="group-active" class="mb-6 hidden">
                <h3 class="text-xs font-bold text-gray-500 uppercase mb-2 px-1 flex items-center">
                    <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>–í —Ä–æ–±–æ—Ç—ñ
                </h3>
                <div id="active-list" class="space-y-3"></div>
            </div>

            <div id="group-archive" class="mb-6 hidden">
                <h3 class="text-xs font-bold text-gray-400 uppercase mb-2 px-1 flex items-center">
                    <span class="w-2 h-2 bg-gray-300 rounded-full mr-2"></span>–ê—Ä—Ö—ñ–≤
                </h3>
                <div id="archive-list" class="space-y-3 opacity-80"></div>
            </div>

            <div id="empty-state" class="hidden text-center mt-12 text-gray-400">
                <i class="fa-regular fa-folder-open text-4xl mb-3"></i>
                <p>–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</p>
            </div>
        </div>
    </main>

    <div id="details-modal" class="fixed inset-0 z-40 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 transition-opacity backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-0 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden bg-white text-left shadow-xl transition-all w-full h-full sm:h-auto sm:rounded-xl flex flex-col sm:max-w-lg sm:my-8">
                    
                    <div class="bg-gray-50 px-4 py-4 border-b flex justify-between items-center shrink-0">
                        <div>
                            <div class="text-xs text-gray-400 font-bold uppercase tracking-wider" id="m-id">#0000</div>
                            <h3 class="text-lg font-bold leading-6 text-gray-900" id="m-type">–¢–∏–ø</h3>
                        </div>
                        <button onclick="closeModal()" class="w-8 h-8 rounded-full bg-gray-200 text-gray-500 hover:bg-gray-300 flex items-center justify-center">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <div class="px-5 py-5 overflow-y-auto flex-1 bg-white">
                        <div class="mb-5 flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                            <span class="text-sm font-medium text-gray-600">–°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏:</span>
                            <span id="m-status-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase">...</span>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs text-gray-400 uppercase font-bold">–ö–ª—ñ—î–Ω—Ç</label>
                                <p id="m-client" class="text-gray-900 font-medium"></p>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs text-gray-400 uppercase font-bold">‚Ññ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó</label>
                                    <p id="m-invoice" class="text-gray-900 font-medium"></p>
                                </div>
                                <div>
                                    <label class="text-xs text-gray-400 uppercase font-bold">–î–∞—Ç–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏</label>
                                    <p id="m-date-proc" class="text-gray-900 font-medium"></p>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-400 uppercase font-bold">–ü—Ä–µ–ø–∞—Ä–∞—Ç / –õ–û–¢</label>
                                <p class="text-blue-600 font-bold text-lg"><span id="m-product"></span> <span id="m-lot" class="text-gray-500 font-normal text-sm ml-2"></span></p>
                            </div>
                        </div>

                        <div id="m-dynamic-details" class="mt-6 border-t pt-4">
                            <h4 class="text-sm font-bold text-gray-800 mb-3"><i class="fa-solid fa-clipboard-list mr-2 text-blue-500"></i>–î–µ—Ç–∞–ª—ñ –∞–Ω–∫–µ—Ç–∏</h4>
                            <div id="m-dynamic-content" class="text-sm space-y-2 bg-blue-50 p-3 rounded-lg">
                                </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 px-4 py-3 shrink-0 border-t flex justify-center">
                        <button type="button" class="w-full justify-center rounded-lg bg-white px-3 py-3 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50" onclick="closeModal()">–ó–∞–∫—Ä–∏—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <nav class="bg-white border-t border-gray-200 fixed bottom-0 w-full z-20 pb-safe">
        <div class="flex justify-around items-center h-16">
            <button onclick="switchTab('new')" id="nav-new" class="flex-1 h-full text-blue-600 flex flex-col items-center justify-center">
                <i class="fa-solid fa-circle-plus text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase">–ü–æ–¥–∞—Ç–∏</span>
            </button>
            <button onclick="switchTab('history')" id="nav-history" class="flex-1 h-full text-gray-400 flex flex-col items-center justify-center">
                <i class="fa-solid fa-clock-rotate-left text-xl mb-1"></i>
                <span class="text-[10px] font-bold uppercase">–Ü—Å—Ç–æ—Ä—ñ—è</span>
            </button>
        </div>
    </nav>

    <script>
        // --- –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø (–¢–µ —Å–∞–º–µ, —â–æ –π –±—É–ª–æ) ---
        const FORMS_CONFIG = {
            'VITARAN': [
                { id: 'tool', label: '–ß–∏–º –ø—Ä–æ–≤–æ–¥–∏–ª–∏', type: 'text' },
                { id: 'anesthesia', label: '–ó–Ω–µ–±–æ–ª–µ–Ω–Ω—è', type: 'text' },
                { id: 'technique', label: '–¢–µ—Ö–Ω—ñ–∫–∞', type: 'textarea' },
                { id: 'post_proc', label: '–ü–æ—Å—Ç–ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–∏–π –ø–µ—Ä—ñ–æ–¥', type: 'textarea' },
                { id: 'allergies', label: '–ê–ª–µ—Ä–≥—ñ—ó', type: 'text' },
                { id: 'cosmetics', label: '–ö–æ—Å–º–µ—Ç–∏–∫–∞ –ø–∞—Ü—ñ—î–Ω—Ç–∞', type: 'text' }
            ],
            'NEURONOX': [
                { id: 'diluent', label: '–ß–∏–º –≤—ñ–¥–Ω–æ–≤–ª—é–≤–∞–ª–∏ / –æ–±\'—î–º', type: 'text' },
                { id: 'date_dilution', label: '–î–∞—Ç–∞ —Ä–æ–∑–≤–µ–¥–µ–Ω–Ω—è', type: 'date' },
                { id: 'prev_botox', label: '–ü–æ–ø–µ—Ä–µ–¥–Ω—è –±–æ—Ç—É–ª—ñ–Ω–æ—Ç–µ—Ä–∞–ø—ñ—è', type: 'textarea' },
                { id: 'illness', label: '–ó–∞—Ö–≤–æ—Ä—é–≤–∞–Ω–Ω—è', type: 'text' },
                { id: 'meds', label: '–õ—ñ–∫–∏ –∑–∞—Ä–∞–∑', type: 'text' }
            ],
            'NEURAMIS': [
                { id: 'tool', label: '–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç', type: 'text' },
                { id: 'prev_contour', label: '–ö–æ–Ω—Ç—É—Ä–Ω–∞ —Ä–∞–Ω—ñ—à–µ?', type: 'text' },
                { id: 'hyaluronidase', label: '–ì—ñ–∞–ª—É—Ä–æ–Ω—ñ–¥–∞–∑–∞?', type: 'select', options: ['–ù—ñ', '–¢–∞–∫'] },
                { id: 'status_localis', label: 'Status Localis', type: 'textarea' }
            ],
            'ELLANSE': [
                { id: 'vaccination', label: '–í–∞–∫—Ü–∏–Ω–∞—Ü—ñ—è', type: 'text' },
                { id: 'autoimmune', label: '–ê—É—Ç–æ—ñ–º—É–Ω–Ω—ñ', type: 'text' },
                { id: 'diet', label: '–î—ñ—î—Ç–∞', type: 'text' },
                { id: 'tool', label: '–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç', type: 'text' }
            ],
            'PETARAN': [
                { id: 'dilution_lido', label: '–õ—ñ–¥–æ–∫–∞—ó–Ω –ø—Ä–∏ —Ä–æ–∑–≤–µ–¥–µ–Ω–Ω—ñ?', type: 'select', options: ['–ù—ñ', '–¢–∞–∫'] },
                { id: 'massage', label: '–ú–∞—Å–∞–∂?', type: 'select', options: ['–¢–∞–∫', '–ù—ñ', '–ù–µ –∑–Ω–∞—é'] },
                { id: 'allergies_poly', label: '–ê–ª–µ—Ä–≥—ñ—è –Ω–∞ –ø–æ–ª—ñ–Ω—É–∫–ª.?', type: 'text' }
            ],
            'OTHER': [
                { id: 'problem_desc', label: '–û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏', type: 'textarea' }
            ]
        };

        const STATUS_LABELS = {
            'new': { text: '–ù–æ–≤–∞', class: 'bg-blue-100 text-blue-700 border-blue-200' },
            'work': { text: '–í —Ä–æ–±–æ—Ç—ñ', class: 'bg-yellow-100 text-yellow-700 border-yellow-200' },
            'done': { text: '–í–∏—Ä—ñ—à–µ–Ω–æ', class: 'bg-green-100 text-green-700 border-green-200' },
            'reject': { text: '–í—ñ–¥–º–æ–≤–∞', class: 'bg-red-100 text-red-700 border-red-200' }
        };

        const TYPE_LABELS = {
            'defect_pack': 'üì¶ –ë—Ä–∞–∫ —É–ø–∞–∫–æ–≤–∫–∏',
            'quality': 'üíé –Ø–∫—ñ—Å—Ç—å',
            'effectiveness': 'üìâ –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å',
            'side_effect': 'ü§í –ü–æ–±—ñ—á–Ω–∞ –¥—ñ—è',
            'complication': 'üöë –£—Å–∫–ª–∞–¥–Ω–µ–Ω–Ω—è'
            'other': 'üìù –Ü–Ω—à–µ'
        };

        // --- –õ–û–ì–Ü–ö–ê –î–ò–ù–ê–ú–Ü–ß–ù–û–á –§–û–†–ú–ò ---
        function renderDynamicForm() {
            const product = document.getElementById('product').value;
            const container = document.getElementById('dynamic-form-area');
            const fieldsContainer = document.getElementById('dynamic-fields');
            
            fieldsContainer.innerHTML = '';
            
            if (!product || !FORMS_CONFIG[product]) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            
            FORMS_CONFIG[product].forEach(field => {
                let html = '';
                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ label –≤ data-attribute, —â–æ–± –ø–æ—Ç—ñ–º –ø–æ–∫–∞–∑–∞—Ç–∏ –≤ —ñ—Å—Ç–æ—Ä—ñ—ó
                if (field.type === 'textarea') {
                    html = `<div><label class="block text-xs font-medium text-gray-600 mb-1">${field.label}</label><textarea data-label="${field.label}" id="custom_${field.id}" rows="2" class="w-full bg-white border border-gray-300 rounded p-2 text-sm outline-none"></textarea></div>`;
                } else if (field.type === 'select') {
                    const opts = field.options.map(o => `<option>${o}</option>`).join('');
                    html = `<div><label class="block text-xs font-medium text-gray-600 mb-1">${field.label}</label><select data-label="${field.label}" id="custom_${field.id}" class="w-full bg-white border border-gray-300 rounded p-2 text-sm outline-none">${opts}</select></div>`;
                } else {
                    html = `<div><label class="block text-xs font-medium text-gray-600 mb-1">${field.label}</label><input type="${field.type}" data-label="${field.label}" id="custom_${field.id}" class="w-full bg-white border border-gray-300 rounded p-2 text-sm outline-none"></div>`;
                }
                fieldsContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        // --- –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø ---
        let currentUser = localStorage.getItem('emet_user');
        
        function checkAuth() {
            if (currentUser) {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('current-user-display').innerText = currentUser;
                renderHistory();
            } else {
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }
        function loginUser() {
            const name = document.getElementById('login-name').value.trim();
            if (name) {
                currentUser = name;
                localStorage.setItem('emet_user', currentUser);
                checkAuth();
            }
        }

        // --- SUBMIT ---
        function submitForm(event) {
            event.preventDefault();
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            
            btnText.innerText = '–í—ñ–¥–ø—Ä–∞–≤–∫–∞...';
            btnLoader.classList.remove('hidden');

            const product = document.getElementById('product').value;
            
            // –ó–±–∏—Ä–∞—î–º–æ –¥–∏–Ω–∞–º—ñ—á–Ω—ñ –ø–æ–ª—è
            let customData = {};
            if (FORMS_CONFIG[product]) {
                FORMS_CONFIG[product].forEach(field => {
                    const el = document.getElementById(`custom_${field.id}`);
                    if(el) customData[field.label] = el.value;
                });
            }

            // –û—Å–Ω–æ–≤–Ω—ñ –¥–∞–Ω—ñ
            const newClaim = {
                id: Math.floor(Math.random() * 9000) + 1000,
                date: new Date().toLocaleDateString(),
                status: 'new',
                type: document.getElementById('claimType').value,
                client: document.getElementById('client').value,
                invoice: document.getElementById('invoice').value,
                product: product,
                lot: document.getElementById('lot').value,
                date_proc: document.getElementById('date_proc').value,
                details: customData // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–±'—î–∫—Ç –∑ –¥–µ—Ç–∞–ª—è–º–∏
            };

            setTimeout(() => {
                let history = JSON.parse(localStorage.getItem('emet_history')) || [];
                history.unshift(newClaim);
                localStorage.setItem('emet_history', JSON.stringify(history));

                btnText.innerText = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ä–µ–∫–ª–∞–º–∞—Ü—ñ—é';
                btnLoader.classList.add('hidden');
                
                alert('‚úÖ –†–µ–∫–ª–∞–º–∞—Ü—ñ—é —Å—Ç–≤–æ—Ä–µ–Ω–æ!');
                document.getElementById('claimForm').reset();
                document.getElementById('dynamic-form-area').classList.add('hidden');
                document.getElementById('preview-area').innerHTML = '';
                switchTab('history');
            }, 1000);
        }

        // --- RENDER HISTORY (NEW: GROUPING) ---
        function renderHistory() {
            const activeContainer = document.getElementById('active-list');
            const archiveContainer = document.getElementById('archive-list');
            const groupActive = document.getElementById('group-active');
            const groupArchive = document.getElementById('group-archive');
            const emptyState = document.getElementById('empty-state');
            
            activeContainer.innerHTML = '';
            archiveContainer.innerHTML = '';
            
            let history = JSON.parse(localStorage.getItem('emet_history')) || [];
            
            if (history.length === 0) {
                emptyState.classList.remove('hidden');
                groupActive.classList.add('hidden');
                groupArchive.classList.add('hidden');
                return;
            }
            emptyState.classList.add('hidden');

            let hasActive = false;
            let hasArchive = false;

            history.forEach(item => {
                const style = STATUS_LABELS[item.status] || STATUS_LABELS['new'];
                const typeText = TYPE_LABELS[item.type] || item.type;
                
                // HTML –∫–∞—Ä—Ç–∫–∏ (—Ç–µ–ø–µ—Ä –∑ onclick)
                const cardHtml = `
                <div onclick="openModal(${item.id})" class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 relative overflow-hidden active:scale-[0.98] transition cursor-pointer">
                    <div class="absolute right-3 top-3 text-gray-300"><i class="fa-solid fa-chevron-right"></i></div>
                    <div class="flex justify-between items-center mb-2 pr-6">
                        <span class="text-[10px] font-bold text-gray-400">#${item.id} ‚Ä¢ ${item.date}</span>
                        <span class="${style.class} text-[10px] font-bold px-2 py-0.5 rounded-full border uppercase tracking-wide">${style.text}</span>
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 text-sm mb-1">${item.client}</h3>
                        <div class="flex items-center gap-2 flex-wrap">
                            <span class="text-xs font-semibold bg-gray-100 px-2 py-1 rounded text-gray-600">${typeText}</span>
                            <span class="text-xs text-blue-600 border border-blue-100 bg-blue-50 px-2 py-1 rounded">${item.product}</span>
                        </div>
                    </div>
                </div>`;

                // –°–æ—Ä—Ç—É–≤–∞–Ω–Ω—è –ø–æ –≥—Ä—É–ø–∞—Ö
                if (['new', 'work'].includes(item.status)) {
                    activeContainer.innerHTML += cardHtml;
                    hasActive = true;
                } else {
                    archiveContainer.innerHTML += cardHtml;
                    hasArchive = true;
                }
            });

            // –ü–æ–∫–∞–∑—É—î–º–æ/—Ö–æ–≤–∞—î–º–æ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –≥—Ä—É–ø
            groupActive.classList.toggle('hidden', !hasActive);
            groupArchive.classList.toggle('hidden', !hasArchive);
        }

        // --- MODAL LOGIC (NEW) ---
        function openModal(id) {
            let history = JSON.parse(localStorage.getItem('emet_history')) || [];
            const claim = history.find(c => c.id === id);
            if (!claim) return;

            // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å—Ç–∞—Ç–∏–∫—É
            document.getElementById('m-id').innerText = `#${claim.id}`;
            document.getElementById('m-type').innerText = TYPE_LABELS[claim.type] || claim.type;
            document.getElementById('m-client').innerText = claim.client;
            document.getElementById('m-invoice').innerText = claim.invoice;
            document.getElementById('m-date-proc').innerText = claim.date_proc || '-';
            document.getElementById('m-product').innerText = claim.product;
            document.getElementById('m-lot').innerText = claim.lot ? `(LOT: ${claim.lot})` : '';

            // –°—Ç–∞—Ç—É—Å
            const style = STATUS_LABELS[claim.status] || STATUS_LABELS['new'];
            const badge = document.getElementById('m-status-badge');
            badge.className = `px-3 py-1 rounded-full text-xs font-bold uppercase ${style.class}`;
            badge.innerText = style.text;

            // –î–∏–Ω–∞–º—ñ—á–Ω—ñ –ø–æ–ª—è
            const dynContainer = document.getElementById('m-dynamic-content');
            dynContainer.innerHTML = '';
            
            if (claim.details && Object.keys(claim.details).length > 0) {
                for (const [key, value] of Object.entries(claim.details)) {
                    if(value) {
                        dynContainer.innerHTML += `
                        <div class="mb-2 border-b border-blue-100 last:border-0 pb-1 last:pb-0">
                            <span class="text-xs text-gray-500 uppercase font-bold block">${key}:</span>
                            <span class="text-gray-900 font-medium">${value}</span>
                        </div>`;
                    }
                }
                document.getElementById('m-dynamic-details').classList.remove('hidden');
            } else {
                document.getElementById('m-dynamic-details').classList.add('hidden');
            }

            document.getElementById('details-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('details-modal').classList.add('hidden');
        }

        // --- TAB SWITCH ---
        function switchTab(tabName) {
            document.getElementById('tab-new').classList.toggle('hidden', tabName !== 'new');
            document.getElementById('tab-history').classList.toggle('hidden', tabName !== 'history');
            
            const navNew = document.getElementById('nav-new');
            const navHist = document.getElementById('nav-history');
            
            if(tabName === 'new') {
                navNew.classList.add('text-blue-600'); navNew.classList.remove('text-gray-400');
                navHist.classList.add('text-gray-400'); navHist.classList.remove('text-blue-600');
            } else {
                navHist.classList.add('text-blue-600'); navHist.classList.remove('text-gray-400');
                navNew.classList.add('text-gray-400'); navNew.classList.remove('text-blue-600');
                renderHistory();
            }
        }

        function previewFiles() {
            const preview = document.getElementById('preview-area');
            const files = document.getElementById('dropzone-file').files;
            preview.innerHTML = '';
            if (files) {
                [].forEach.call(files, function(file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const div = document.createElement('div');
                        div.className = 'flex-shrink-0 w-14 h-14 rounded-lg overflow-hidden border border-gray-200';
                        div.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
                        preview.appendChild(div);
                    }
                    reader.readAsDataURL(file);
                });
            }
        }

        checkAuth();
    </script>
</body>
</html>
