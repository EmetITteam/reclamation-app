<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Service Desk | Emet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader { border-top-color: #3B82F6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .required-mark::after { content: " *"; color: red; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col">

    <div id="login-screen" class="fixed inset-0 bg-white z-50 flex flex-col justify-center items-center p-6">
        <div class="text-center w-full max-w-sm">
            <div class="bg-blue-100 p-4 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-6">
                <i class="fa-solid fa-user-doctor text-3xl text-blue-600"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">–í—Ö—ñ–¥ —É —Å–∏—Å—Ç–µ–º—É</h2>
            <p class="text-gray-500 mb-6 text-sm">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å —è–∫ –º–µ–Ω–µ–¥–∂–µ—Ä –∞–±–æ —É–≤—ñ–π–¥—ñ—Ç—å —è–∫ –ª—ñ–∫–∞—Ä</p>
            
            <div id="manager-form">
                <input type="email" id="login-email" class="w-full border border-gray-300 rounded-lg p-3 mb-3 text-center text-lg" placeholder="Email (–õ–æ–≥—ñ–Ω)">
                <input type="password" id="login-password" class="w-full border border-gray-300 rounded-lg p-3 mb-4 text-center text-lg" placeholder="–ü–∞—Ä–æ–ª—å">
                <button onclick="loginManager()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow hover:bg-blue-700 mb-3" id="btn-login">–£–≤—ñ–π—Ç–∏</button>
            </div>

            <div class="relative flex py-2 items-center w-full">
                <div class="flex-grow border-t border-gray-200"></div>
                <span class="flex-shrink-0 mx-4 text-gray-400 text-xs uppercase">–∞–±–æ</span>
                <div class="flex-grow border-t border-gray-200"></div>
            </div>

            <button onclick="loginAsDoctor()" class="w-full bg-white border-2 border-blue-600 text-blue-600 font-bold py-3 rounded-lg shadow-sm hover:bg-blue-50 mt-3">
                <i class="fa-solid fa-stethoscope mr-2"></i>–Ø –õ—ñ–∫–∞—Ä / –ö–ª—ñ—î–Ω—Ç
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-3 hidden"></p>
        </div>
    </div>

    <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 shrink-0">
        <h1 class="text-lg font-bold text-blue-800 flex items-center gap-2">
            <i class="fa-solid fa-notes-medical"></i> EMET Service Desk
        </h1>
        <div class="text-xs text-right">
            <div class="text-gray-400">–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</div>
            <div class="font-bold mb-1" id="current-user-display">...</div>
            <button onclick="logoutUser()" class="text-red-500 font-bold hover:text-red-700 hover:underline">
                <i class="fa-solid fa-right-from-bracket mr-1"></i>–í–∏–π—Ç–∏
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-y-auto p-3 pb-24 no-scrollbar">
        
        <div id="tab-new" class="block">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                <h2 class="text-lg font-semibold mb-4 border-b pb-2">–ù–æ–≤–∞ —Ä–µ–∫–ª–∞–º–∞—Ü—ñ—è</h2>
                <form id="claimForm" onsubmit="submitForm(event)">
                    
                    <div class="mb-5">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2 required-mark">–¢–∏–ø –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è</label>
                        <select id="claimType" onchange="renderDynamicForm()" class="w-full border rounded-lg p-3 bg-white" required>
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å —Ç–∏–ø...</option>
                            <option value="defect_pack">üì¶ –ë—Ä–∞–∫ —É–ø–∞–∫–æ–≤–∫–∏</option>
                            <option value="quality">üíé –Ø–∫—ñ—Å—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç—É</option>
                            <option value="effectiveness">üìâ –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å</option>
                            <option value="side_effect">ü§í –ü–æ–±—ñ—á–Ω–∞ –¥—ñ—è</option>
                            <option value="complication">üöë –£—Å–∫–ª–∞–¥–Ω–µ–Ω–Ω—è</option>
                            <option value="other">üìù –Ü–Ω—à–µ</option>
                        </select>
                    </div>

                    <div class="grid grid-cols-1 gap-3 mb-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 required-mark">–ö–ª—ñ—î–Ω—Ç (–õ—ñ–∫–∞—Ä/–°–∞–ª–æ–Ω)</label>
                            <input type="text" id="client" class="w-full border rounded-lg p-3" placeholder="–ü–Ü–ë –ª—ñ–∫–∞—Ä—è" required>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">‚Ññ –†–µ–∞–ª—ñ–∑–∞—Ü—ñ—ó</label>
                            <input type="text" id="invoice" class="w-full border rounded-lg p-3" placeholder="–ù–µ –æ–±–æ–≤'—è–∑–∫–æ–≤–æ">
                        </div>
                    </div>

                    <div class="mb-5 bg-blue-50 p-3 rounded-lg border border-blue-100">
                        <label class="block text-xs font-bold text-blue-800 uppercase mb-2 required-mark">–ü—Ä–µ–ø–∞—Ä–∞—Ç</label>
                        <select id="product" onchange="renderDynamicForm()" class="w-full border rounded-lg p-3 bg-white" required>
                            <option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç...</option>
                            <option value="VITARAN">HP CELL VITARAN (–≤—Å—ñ)</option>
                            <option value="NEURONOX">NEURONOX</option>
                            <option value="NEURAMIS">NEURAMIS</option>
                            <option value="ELLANSE">ELLANSE</option>
                            <option value="PETARAN">PETARAN</option>
                            <option value="OTHER">–Ü–Ω—à–µ / –ö–æ—Å–º–µ—Ü–µ–≤—Ç–∏–∫–∞</option>
                        </select>
                        <div class="mt-3">
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1 required-mark">LOT / –°–µ—Ä—ñ—è</label>
                            <input type="text" id="lot" class="w-full border rounded-lg p-3" placeholder="–í–∫–∞–∂—ñ—Ç—å LOT —ñ–∑ —É–ø–∞–∫–æ–≤–∫–∏" required>
                        </div>
                    </div>

                    <div id="dynamic-form-area" class="hidden mb-5 border-t pt-4">
                        <h3 class="text-sm font-bold text-gray-700 mb-3">–î–µ—Ç–∞–ª—ñ —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—É</h3>
                        <div id="dynamic-fields" class="space-y-3"></div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">–ú–µ–¥—ñ–∞ –¥–æ–∫–∞–∑–∏</label>
                        <label class="flex flex-col items-center justify-center w-full h-20 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100 transition">
                            <i class="fa-solid fa-camera text-gray-400 text-xl"></i>
                            <span class="text-xs text-gray-500 mt-1">–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ</span>
                            <input id="dropzone-file" type="file" class="hidden" multiple accept="image/*,video/*" onchange="previewFiles()" />
                        </label>
                        <div id="preview-area" class="flex gap-2 mt-2 overflow-x-auto p-1"></div>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg flex justify-center items-center">
                        <span id="btn-text">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ä–µ–∫–ª–∞–º–∞—Ü—ñ—é</span>
                        <div id="btn-loader" class="loader h-5 w-5 ml-2 hidden"></div>
                    </button>
                </form>
            </div>
        </div>

        <div id="tab-history" class="hidden">
            <div class="flex justify-between items-center mb-4 px-1">
                <h2 class="text-lg font-semibold">–ú–æ—ó –∑–∞—è–≤–∫–∏</h2>
                <button onclick="syncHistory()" class="text-blue-600 text-sm font-bold flex items-center hover:bg-blue-50 px-2 py-1 rounded">
                    <i class="fa-solid fa-rotate mr-1"></i>–û–Ω–æ–≤–∏—Ç–∏
                </button>
            </div>
            
            <div id="history-loader" class="hidden text-center py-4 bg-white rounded-lg shadow-sm mb-4">
                <div class="loader h-5 w-5 mx-auto border-blue-500"></div>
                <p class="text-xs text-gray-400 mt-2">–°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –∑ –ë—ñ—Ç—Ä—ñ–∫—Å...</p>
            </div>
            
            <div class="relative mb-4">
                <input type="text" id="search-input" oninput="filterHistory()" 
                    class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition" 
                    placeholder="–ü–æ—à—É–∫ –∑–∞ –ø—Ä—ñ–∑–≤–∏—â–µ–º –∞–±–æ ID...">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-3.5 text-gray-400"></i>
            </div>
            
            <div id="active-list" class="space-y-3 mb-6"></div>
            <div id="empty-state" class="hidden text-center mt-12 text-gray-400">
                <i class="fa-regular fa-folder-open text-4xl mb-3"></i>
                <p>–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</p>
            </div>
        </div>
    </main>
    
    <div id="details-modal" class="fixed inset-0 z-40 hidden">
        <div class="fixed inset-0 bg-gray-900 bg-opacity-75 backdrop-blur-sm" onclick="closeModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto flex items-center justify-center p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                
                <div class="bg-gray-50 px-4 py-4 border-b flex justify-between items-center shrink-0">
                    <div>
                        <div class="text-xs text-gray-400 font-bold uppercase tracking-wider" id="m-id">#000</div>
                        <h3 class="font-bold text-lg" id="m-type">...</h3>
                    </div>
                    <button onclick="closeModal()" class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center hover:bg-gray-300">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                
                <div class="p-5 space-y-4 overflow-y-auto">
                    <div class="flex justify-between bg-gray-50 p-3 rounded items-center">
                        <span class="text-sm font-medium text-gray-600">–°—Ç–∞—Ç—É—Å:</span>
                        <span id="m-status-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase">...</span>
                    </div>

                    <div>
                        <label class="text-xs text-gray-400 font-bold uppercase">–ö–ª—ñ—î–Ω—Ç</label>
                        <p id="m-client" class="font-medium text-gray-800">...</p>
                    </div>
                    <div>
                        <label class="text-xs text-gray-400 font-bold uppercase">–ü—Ä–µ–ø–∞—Ä–∞—Ç / LOT</label>
                        <p class="text-blue-600 font-bold">
                            <span id="m-product"></span> 
                            <span id="m-lot" class="text-gray-500 font-normal text-sm ml-2"></span>
                        </p>
                    </div>
                    
                    <div id="m-comments-area" class="border-t pt-4">
                        <h4 class="text-sm font-bold mb-3 flex items-center text-gray-700">
                            <i class="fa-regular fa-comments mr-2 text-blue-500"></i>–í—ñ–¥–ø–æ–≤—ñ–¥—å –º–µ–¥–∏—á–Ω–æ–≥–æ –≤—ñ–¥–¥—ñ–ª—É
                        </h4>
                        
                        <div id="m-comments-loader" class="text-center py-2 hidden">
                            <div class="loader h-4 w-4 mx-auto border-gray-400"></div>
                        </div>
                        
                        <div id="m-comments-list" class="space-y-3 text-sm max-h-60 overflow-y-auto mb-3"></div>
                        
                        <div id="m-no-comments" class="text-xs text-gray-400 italic hidden text-center py-2 bg-gray-50 rounded">
                            –ù–µ–º–∞—î –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
                        </div>

                        <div class="mt-4 pt-3 border-t border-gray-100">
                            <label class="text-xs font-bold text-gray-400 uppercase mb-1 block">–í–∞—à–∞ –≤—ñ–¥–ø–æ–≤—ñ–¥—å</label>
                            <div class="flex gap-2">
                                <input type="text" id="reply-input" 
                                    class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 outline-none transition" 
                                    placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è...">
                                <button onclick="sendReply()" id="btn-reply" 
                                    class="bg-blue-600 text-white rounded-lg px-4 py-2 text-sm font-bold hover:bg-blue-700 transition flex items-center justify-center min-w-[50px]">
                                    <i class="fa-solid fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="m-dynamic-details" class="hidden border-t pt-4">
                        <h4 class="text-sm font-bold mb-2">–î–µ—Ç–∞–ª—ñ –∞–Ω–∫–µ—Ç–∏</h4>
                        <div id="m-dynamic-content" class="text-sm space-y-2 bg-blue-50 p-3 rounded"></div>
                    </div>
                </div>
                
                <div class="bg-gray-50 px-4 py-3 text-center shrink-0 border-t">
                    <button onclick="closeModal()" class="w-full bg-white border py-3 rounded-lg font-semibold shadow-sm hover:bg-gray-100">–ó–∞–∫—Ä–∏—Ç–∏</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bg-white border-t fixed bottom-0 w-full z-20 pb-safe">
        <div class="flex justify-around h-16 items-center">
            <button onclick="switchTab('new')" id="nav-new" class="flex-1 text-blue-600 flex flex-col items-center">
                <i class="fa-solid fa-circle-plus text-xl"></i>
                <span class="text-[10px] font-bold mt-1">–ü–û–î–ê–¢–ò</span>
            </button>
            <button onclick="switchTab('history')" id="nav-history" class="flex-1 text-gray-400 flex flex-col items-center">
                <i class="fa-solid fa-clock-rotate-left text-xl"></i>
                <span class="text-[10px] font-bold mt-1">–Ü–°–¢–û–†–Ü–Ø</span>
            </button>
        </div>
    </nav>

    <script>
        // --- 1. –ö–û–ù–§–Ü–ì–£–†–ê–¶–Ü–Ø ---
        const FORMS_CONFIG = {
            'VITARAN': [
                {
                    id: 'date_complaint',
                    label: '–î–∞—Ç–∞ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø–∞—Ü—ñ—î–Ω—Ç–∞ —ñ–∑ —Å–∫–∞—Ä–≥–∞–º–∏',
                    type: 'date'
                },
                {
                    id: 'date_proc',
                    label: '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'date'
                },
                {
                    id: 'tool',
                    label: '–ß–∏–º –ø—Ä–æ–≤–æ–¥–∏–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É (–≥–æ–ª–∫–∞, –∫–∞–Ω—é–ª—è), —Ä–æ–∑–º—ñ—Ä',
                    type: 'text'
                },
                {
                    id: 'anesthesia',
                    label: '–ß–∏ –ø—Ä–æ–≤–æ–¥–∏–ª–∏ –∑–Ω–µ–±–æ–ª—é–≤–∞–Ω–Ω—è (—è–∫–∏–º –ø—Ä–µ–ø–∞—Ä–∞—Ç–æ–º)',
                    type: 'text'
                },
                {
                    id: 'technique',
                    label: '–û–ø–∏—à—ñ—Ç—å —Ç–µ—Ö–Ω—ñ–∫—É –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'textarea'
                },
                {
                    id: 'complaints_during',
                    label: '–°–∫–∞—Ä–≥–∏ –ø—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'textarea'
                },
                {
                    id: 'post_proc',
                    label: '–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É',
                    type: 'textarea'
                },
                {
                    id: 'complaints_now',
                    label: '–°–∫–∞—Ä–≥–∏ –ø–∞—Ü—ñ—î–Ω—Ç–∞ –≤ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç',
                    type: 'textarea'
                },
                {
                    id: 'status_localis',
                    label: 'Status Localis (–¥–∞–Ω—ñ –æ–≥–ª—è–¥—É)',
                    type: 'textarea'
                },
                {
                    id: 'allergies',
                    label: '–°—Ö–∏–ª—å–Ω—ñ—Å—Ç—å –ø–∞—Ü—ñ—î–Ω—Ç–∞ –¥–æ –∞–ª–µ—Ä–≥—ñ—á–Ω–∏—Ö —Ä–µ–∞–∫—Ü—ñ–π, –∑–æ–∫—Ä–µ–º–∞ –Ω–∞ –ü–ù?',
                    type: 'select',
                    options: ['–ù—ñ', '–¢–∞–∫']
                },
                {
                    id: 'illness',
                    label: '–ß–∏–º —Ö–≤–æ—Ä—ñ–≤ (–ª–∞) –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 2 –º—ñ—Å—è—Ü—ñ?',
                    type: 'textarea'
                },
                {
                    id: 'cosmetics',
                    label: '–Ø–∫—ñ –∫–æ—Å–º–µ—Ç–∏—á–Ω—ñ –∑–∞—Å–æ–±–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î?',
                    type: 'text'
                },
                {
                    id: 'meds',
                    label: '–Ø–∫—ñ –ª—ñ–∫–∏ –ø—Ä–∏–π–º–∞—î –∑–∞—Ä–∞–∑?',
                    type: 'textarea'
                }
            ],
            'NEURONOX': [
                {
                    id: 'date_complaint',
                    label: '–î–∞—Ç–∞ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø–∞—Ü—ñ—î–Ω—Ç–∞',
                    type: 'date'
                },
                {
                    id: 'date_proc',
                    label: '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'date'
                },
                {
                    id: 'date_dilution',
                    label: '–î–∞—Ç–∞ –≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è (—Ä–æ–∑–≤–µ–¥–µ–Ω–Ω—è)',
                    type: 'date'
                },
                {
                    id: 'diluent',
                    label: '–ß–∏–º –≤—ñ–¥–Ω–æ–≤–ª—é–≤–∞–ª–∏ —Ç–∞ –æ–±—î–º —Ä–æ–∑—á–∏–Ω–Ω–∏–∫–∞',
                    type: 'text'
                },
                {
                    id: 'anesthesia',
                    label: '–ó–Ω–µ–±–æ–ª–µ–Ω–Ω—è (–ø—Ä–µ–ø–∞—Ä–∞—Ç)',
                    type: 'text'
                },
                {
                    id: 'patient_age',
                    label: '–í—ñ–∫ –ø–∞—Ü—ñ—î–Ω—Ç–∞',
                    type: 'text'
                },
                {
                    id: 'prev_botox_date',
                    label: '–î–∞—Ç–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –±–æ—Ç—É–ª—ñ–Ω–æ—Ç–µ—Ä–∞–ø—ñ—ó',
                    type: 'date'
                },
                {
                    id: 'prev_botox_drug',
                    label: '–ü—Ä–µ–ø–∞—Ä–∞—Ç –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ—ó –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'text'
                },
                {
                    id: 'prev_effect',
                    label: '–¢—Ä–∏–≤–∞–ª—ñ—Å—Ç—å –µ—Ñ–µ–∫—Ç—É –ø–æ–ø–µ—Ä. –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'text'
                },
                {
                    id: 'illness_chronic',
                    label: '–ó–∞—Ö–≤–æ—Ä—é–≤–∞–Ω–Ω—è (–≥–æ—Å—Ç—Ä—ñ, —Ö—Ä–æ–Ω—ñ—á–Ω—ñ)',
                    type: 'textarea'
                },
                {
                    id: 'recent_infection',
                    label: '–Ø–∫ –¥–∞–≤–Ω–æ —Ö–≤–æ—Ä—ñ–≤ —ñ–Ω—Ñ–µ–∫—Ü—ñ–π–Ω–∏–º–∏ –∑–∞—Ö–≤–æ—Ä—é–≤–∞–Ω–Ω—è–º–∏?',
                    type: 'text'
                },
                {
                    id: 'meds',
                    label: '–Ø–∫—ñ –ª—ñ–∫–∏ –ø—Ä–∏–π–º–∞—î?',
                    type: 'textarea'
                }
            ],
            'NEURAMIS': [
                {
                    id: 'date_complaint',
                    label: '–î–∞—Ç–∞ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø–∞—Ü—ñ—î–Ω—Ç–∞',
                    type: 'date'
                },
                {
                    id: 'date_proc',
                    label: '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'date'
                },
                {
                    id: 'tool',
                    label: '–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (–≥–æ–ª–∫–∞/–∫–∞–Ω—é–ª—è, —Ä–æ–∑–º—ñ—Ä)',
                    type: 'text'
                },
                {
                    id: 'anesthesia',
                    label: '–ó–Ω–µ–±–æ–ª–µ–Ω–Ω—è (–ø—Ä–µ–ø–∞—Ä–∞—Ç)',
                    type: 'text'
                },
                {
                    id: 'complaints_during',
                    label: '–°–∫–∞—Ä–≥–∏ –ø—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'textarea'
                },
                {
                    id: 'post_proc',
                    label: '–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É',
                    type: 'textarea'
                },
                {
                    id: 'complaints_now',
                    label: '–°–∫–∞—Ä–≥–∏ –Ω–∞ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç',
                    type: 'textarea'
                },
                {
                    id: 'status_localis',
                    label: 'Status Localis (–¥–∞–Ω—ñ –æ–≥–ª—è–¥—É)',
                    type: 'textarea'
                },
                {
                    id: 'prev_contour',
                    label: '–ü–æ–ø–µ—Ä–µ–¥–Ω—è –ø–ª–∞—Å—Ç–∏–∫–∞ —Ü—ñ—î—ó –∑–æ–Ω–∏: –ø—Ä–µ–ø–∞—Ä–∞—Ç?',
                    type: 'textarea'
                },
                {
                    id: 'prev_complaints',
                    label: '–°–∫–∞—Ä–≥–∏ –ø—ñ—Å–ª—è –ø–æ–ø–µ—Ä. –ø—Ä–æ—Ü–µ–¥—É—Ä–∏?',
                    type: 'textarea'
                },
                {
                    id: 'hyaluronidase',
                    label: '–ß–∏ –∑–∞—Å—Ç–æ—Å–æ–≤—É–≤–∞–ª–∏ –≥—ñ–∞–ª—É—Ä–æ–Ω—ñ–¥–∞–∑—É?',
                    type: 'select',
                    options: ['–ù—ñ', '–¢–∞–∫']
                },
                {
                    id: 'allergies',
                    label: '–°—Ö–∏–ª—å–Ω—ñ—Å—Ç—å –¥–æ –∞–ª–µ—Ä–≥—ñ—á–Ω–∏—Ö —Ä–µ–∞–∫—Ü—ñ–π?',
                    type: 'select',
                    options: ['–ù—ñ', '–¢–∞–∫']
                },
                {
                    id: 'illness',
                    label: '–ß–∏–º —Ö–≤–æ—Ä—ñ–≤ –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 2 –º—ñ—Å?',
                    type: 'textarea'
                },
                {
                    id: 'meds',
                    label: '–Ø–∫—ñ –ª—ñ–∫–∏ –ø—Ä–∏–π–º–∞—î –∑–∞—Ä–∞–∑?',
                    type: 'textarea'
                }
            ],
            'ELLANSE': [
                {
                    id: 'date_complaint',
                    label: '–î–∞—Ç–∞ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø–∞—Ü—ñ—î–Ω—Ç–∞ —ñ–∑ —Å–∫–∞—Ä–≥–∞–º–∏',
                    type: 'date'
                },
                {
                    id: 'date_proc',
                    label: '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'date'
                },
                {
                    id: 'tool',
                    label: '–ß–∏–º –ø—Ä–æ–≤–æ–¥–∏–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É (–≥–æ–ª–∫–∞, –∫–∞–Ω—é–ª—è), —Ä–æ–∑–º—ñ—Ä',
                    type: 'text'
                },
                {
                    id: 'complaints_during',
                    label: '–°–∫–∞—Ä–≥–∏ –ø—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'textarea'
                },
                {
                    id: 'post_proc',
                    label: '–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É',
                    type: 'textarea'
                },
                {
                    id: 'complaints_now',
                    label: '–°–∫–∞—Ä–≥–∏ –ø–∞—Ü—ñ—î–Ω—Ç–∞ –≤ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç',
                    type: 'textarea'
                },
                {
                    id: 'status_localis',
                    label: 'Status Localis (–¥–∞–Ω—ñ –æ–≥–ª—è–¥—É)',
                    type: 'textarea'
                },
                {
                    id: 'vaccination',
                    label: '–î–∞—Ç–∞ –æ—Å—Ç–∞–Ω–Ω—å–æ—ó –≤–∞–∫—Ü–∏–Ω–∞—Ü—ñ—ó, —è–∫–∞ —Å–∞–º–µ –≤–∞–∫—Ü–∏–Ω–∞?',
                    type: 'text'
                },
                {
                    id: 'autoimmune',
                    label: '–ó–∞—Ö–≤–æ—Ä—é–≤–∞–Ω–Ω—è —Å–ø–æ–ª—É—á–Ω–æ—ó —Ç–∫–∞–Ω–∏–Ω–∏ –∞–±–æ –∞–≤—Ç–æ—ñ–º—É–Ω–Ω—ñ?',
                    type: 'textarea'
                },
                {
                    id: 'diet',
                    label: '–ß–∏ –¥–æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –ø–∞—Ü—ñ—î–Ω—Ç –æ—Å–æ–±–ª–∏–≤–æ—ó –¥—ñ—î—Ç–∏?',
                    type: 'text'
                },
                {
                    id: 'illness',
                    label: '–ß–∏–º —Ö–≤–æ—Ä—ñ–≤ (–ª–∞) –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 2 –º—ñ—Å—è—Ü—ñ?',
                    type: 'textarea'
                },
                {
                    id: 'meds',
                    label: '–Ø–∫—ñ –ª—ñ–∫–∏ / –ë–ê–î–∏ –ø—Ä–∏–π–º–∞—î –∑–∞—Ä–∞–∑?',
                    type: 'textarea'
                },
                {
                    id: 'other_procs',
                    label: '–Ø–∫—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ —Ä–æ–±–∏–ª–∏ –≤ —Ü–µ–π –ø–µ—Ä—ñ–æ–¥ (–ø—Ä–µ–ø–∞—Ä–∞—Ç–∏, —á–∞—Å)?',
                    type: 'textarea'
                }
            ],
            'PETARAN': [
                {
                    id: 'date_complaint',
                    label: '–î–∞—Ç–∞ –∑–≤–µ—Ä–Ω–µ–Ω–Ω—è –ø–∞—Ü—ñ—î–Ω—Ç–∞ —ñ–∑ —Å–∫–∞—Ä–≥–∞–º–∏',
                    type: 'date'
                },
                {
                    id: 'date_proc',
                    label: '–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–Ω—è –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'date'
                },
                {
                    id: 'tool',
                    label: '–ß–∏–º –ø—Ä–æ–≤–æ–¥–∏–ª–∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—É (–≥–æ–ª–∫–∞, –∫–∞–Ω—é–ª—è), —Ä–æ–∑–º—ñ—Ä',
                    type: 'text'
                },
                {
                    id: 'dilution_lido',
                    label: '–Ø–∫ –ø—Ä–æ–≤–æ–¥–∏–ª–∏ —Ä–æ–∑–≤–µ–¥–µ–Ω–Ω—è, —á–∏ –¥–æ–¥–∞–≤–∞–ª–∏ –ª—ñ–¥–æ–∫–∞—ó–Ω?',
                    type: 'text'
                },
                {
                    id: 'complaints_during',
                    label: '–°–∫–∞—Ä–≥–∏ –ø—ñ–¥ —á–∞—Å –ø—Ä–æ—Ü–µ–¥—É—Ä–∏',
                    type: 'textarea'
                },
                {
                    id: 'post_proc',
                    label: '–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ –ø–æ—Å—Ç–ø—Ä–æ—Ü–µ–¥—É—Ä–Ω–æ–≥–æ –ø–µ—Ä—ñ–æ–¥—É',
                    type: 'textarea'
                },
                {
                    id: 'complaints_now',
                    label: '–°–∫–∞—Ä–≥–∏ –ø–∞—Ü—ñ—î–Ω—Ç–∞ –≤ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç',
                    type: 'textarea'
                },
                {
                    id: 'status_localis',
                    label: 'Status Localis (–¥–∞–Ω—ñ –æ–≥–ª—è–¥—É)',
                    type: 'textarea'
                },
                {
                    id: 'allergies_poly',
                    label: '–°—Ö–∏–ª—å–Ω—ñ—Å—Ç—å –¥–æ –∞–ª–µ—Ä–≥—ñ—á–Ω–∏—Ö —Ä–µ–∞–∫—Ü—ñ–π,–∑–æ–∫—Ä–µ–º–∞ –Ω–∞ –ü–ù?',
                    type: 'select',
                    options: ['–ù—ñ', '–¢–∞–∫']
                },
                {
                    id: 'autoimmune',
                    label: '–ó–∞—Ö–≤–æ—Ä—é–≤–∞–Ω–Ω—è —Å–ø–æ–ª—É—á–Ω–æ—ó —Ç–∫–∞–Ω–∏–Ω–∏ –∞–±–æ –∞–≤—Ç–æ—ñ–º—É–Ω–Ω—ñ?',
                    type: 'textarea'
                },
                {
                    id: 'massage',
                    label: '–ß–∏ –¥–æ—Ç—Ä–∏–º—É–≤–∞–≤—Å—è –ø–∞—Ü—ñ—î–Ω—Ç –≤–∏–º–æ–≥ —â–æ–¥–æ –º–∞—Å–∞–∂—É?',
                    type: 'select',
                    options: ['–¢–∞–∫', '–ù—ñ', '–ù–µ –∑–Ω–∞—é']
                },
                {
                    id: 'illness',
                    label: '–ß–∏–º —Ö–≤–æ—Ä—ñ–≤ (–ª–∞) –∑–∞ –æ—Å—Ç–∞–Ω–Ω—ñ 2 –º—ñ—Å—è—Ü—ñ?',
                    type: 'textarea'
                },
                {
                    id: 'meds',
                    label: '–Ø–∫—ñ –ª—ñ–∫–∏ –ø—Ä–∏–π–º–∞—î –∑–∞—Ä–∞–∑?',
                    type: 'textarea'
                }
            ],
            'OTHER': [
                {
                    id: 'problem_desc',
                    label: '–î–µ—Ç–∞–ª—å–Ω–∏–π –æ–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏',
                    type: 'textarea'
                },
                {
                    id: 'date_proc',
                    label: '–î–∞—Ç–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ (—è–∫—â–æ –±—É–ª–∞)',
                    type: 'date'
                }
            ]
        };


        const STATUS_CONFIG = {
            'new': { text: '–ù–æ–≤–∞', class: 'bg-blue-100 text-blue-700 border-blue-200' },
            'work': { text: '–í —Ä–æ–±–æ—Ç—ñ', class: 'bg-yellow-100 text-yellow-700 border-yellow-200' },
            'done': { text: '–í–∏—Ä—ñ—à–µ–Ω–æ', class: 'bg-green-100 text-green-700 border-green-200' },
            'reject': { text: '–í—ñ–¥–º–æ–≤–∞', class: 'bg-red-100 text-red-700 border-red-200' }
        };

        const TYPE_LABELS = {
            'defect_pack':'üì¶ –ë—Ä–∞–∫ —É–ø–∞–∫–æ–≤–∫–∏',
            'quality':'üíé –Ø–∫—ñ—Å—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç—É',
            'effectiveness':'üìâ –ï—Ñ–µ–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å',
            'side_effect':'ü§í –ü–æ–±—ñ—á–Ω–∞ –¥—ñ—è',
            'complication':'üöë –£—Å–∫–ª–∞–¥–Ω–µ–Ω–Ω—è',
            'other':'üìù –Ü–Ω—à–µ'
        };

        // --- 2. –ó–ú–Ü–ù–ù–Ü ---
        let allClaimsData = []; 

        // --- 3. –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø ---
        function checkAuth() {
            const user = localStorage.getItem('emet_user');
            const email = localStorage.getItem('emet_email');
            
            // –Ø–∫—â–æ —î —Ö–æ—á–∞ –± –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á (–Ω–∞–≤—ñ—Ç—å –±–µ–∑ –ø–æ—à—Ç–∏ - –¥–ª—è –õ—ñ–∫–∞—Ä—è)
            if (user) {
                showApp(user, email);
                // –í–∞–Ω—Ç–∞–∂–∏–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –¢–Ü–õ–¨–ö–ò —è–∫—â–æ —Ü–µ –º–µ–Ω–µ–¥–∂–µ—Ä (—î email)
                if (email && email.trim() !== '') {
                    loadHistoryFromServer(email); 
                }
            } else {
                showLogin();
            }
        }

        function showApp(user, email) {
            document.getElementById('login-screen').classList.add('hidden');
            // –Ø–∫—â–æ –Ω–µ–º–∞—î —ñ–º–µ–Ω—ñ (—Å—Ç–∞—Ä–∏–π –≥–ª—é–∫), –ø–∏—à–µ–º–æ –∑–∞–≥–ª—É—à–∫—É
            document.getElementById('current-user-display').innerText = user || '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á';
        }

        function showLogin() {
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function loginManager(){ 
            const email = document.getElementById('login-email').value; 
            const pass = document.getElementById('login-password').value;
            const btn = document.getElementById('btn-login');
            const err = document.getElementById('login-error');

            if(!email || !pass) {
                err.innerText = "–í–≤–µ–¥—ñ—Ç—å Email —Ç–∞ –ü–∞—Ä–æ–ª—å";
                err.classList.remove('hidden');
                return;
            }

            btn.innerText = "–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞...";
            err.classList.add('hidden');

            fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ email: email, password: pass })
            })
            .then(r => r.json())
            .then(data => {
                btn.innerText = "–£–≤—ñ–π—Ç–∏";
                if(data.status === 'success') {
                    saveUserAndRedirect(data);
                } else {
                    err.innerText = data.message;
                    err.classList.remove('hidden');
                }
            })
            .catch(() => {
                btn.innerText = "–£–≤—ñ–π—Ç–∏";
                err.innerText = "–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞";
                err.classList.remove('hidden');
            });
        }

        function loginAsDoctor() {
            localStorage.setItem('emet_user', '–õ—ñ–∫–∞—Ä (–ì—ñ—Å—Ç—å)');
            localStorage.setItem('emet_email', ''); 
            location.reload();
        }

        function saveUserAndRedirect(data) {
            localStorage.setItem('emet_user', data.name);
            localStorage.setItem('emet_email', data.email);
            window.history.replaceState({}, document.title, "/");
            location.reload();
        }

        function logoutUser() {
            if(confirm('–í–∏ –¥—ñ–π—Å–Ω–æ —Ö–æ—á–µ—Ç–µ –≤–∏–π—Ç–∏ –∑ –∞–∫–∞—É–Ω—Ç—É?')) {
                localStorage.removeItem('emet_user');
                localStorage.removeItem('emet_email');
                location.reload();
            }
        }

        // --- 4. –Ü–°–¢–û–†–Ü–Ø –Ü –ü–û–®–£–ö ---

        async function loadHistoryFromServer(email) {
            const list = document.getElementById('active-list'); 
            
            if (list && list.children.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-400 py-4"><i class="fa-solid fa-spinner fa-spin mr-2"></i>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó...</div>';
            }

            try {
                const formData = new FormData();
                formData.append('email', email);

                const response = await fetch('/api/get_history', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                allClaimsData = data.history || [];
                renderHistory(allClaimsData); 
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó:', error);
                if (list) list.innerHTML = '<div class="text-center text-red-400">–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é</div>';
            }
        }

        function filterHistory() {
            const query = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!query) {
                renderHistory(allClaimsData); 
                return;
            }

            const filtered = allClaimsData.filter(item => {
                const titleMatch = (item.title || "").toLowerCase().includes(query);
                const idMatch = String(item.id).includes(query);
                return titleMatch || idMatch;
            });

            renderHistory(filtered);
        }

        function renderHistory(historyItems) {
            const list = document.getElementById('active-list');
            if (!list) return;
            
            list.innerHTML = ''; 

            if (!historyItems || historyItems.length === 0) {
                list.innerHTML = `
                    <div class="text-center mt-12 text-gray-400">
                        <i class="fa-solid fa-magnifying-glass text-4xl mb-3 opacity-20"></i>
                        <p>–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</p>
                    </div>`;
                return;
            }

            historyItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bg-white p-4 rounded-xl shadow-sm mb-3 border border-gray-100 cursor-pointer active:bg-gray-50 transition';
                div.onclick = function() { openModal(item.id); };

                let stClass = 'bg-blue-100 text-blue-700 border-blue-200';
                let stText = '–ù–æ–≤–∞';

                const status = (item.status || '').toUpperCase();
                
                if(status.includes('–í–ò–†–Ü–®–ï–ù–û') || status.includes('SUCCESS') || status.includes('WON')) { 
                    stClass = 'bg-green-100 text-green-700 border-green-200'; stText = '–í–∏—Ä—ñ—à–µ–Ω–æ'; 
                }
                else if(status.includes('–í–Ü–î–ú–û–í–ê') || status.includes('FAIL') || status.includes('LOSE')) { 
                    stClass = 'bg-red-100 text-red-700 border-red-200'; stText = '–í—ñ–¥–º–æ–≤–∞'; 
                }
                else if(status.includes('–ù–û–í–ê') || status.includes('NEW')) { 
                    stClass = 'bg-blue-100 text-blue-700 border-blue-200'; stText = '–ù–æ–≤–∞'; 
                }
                else { 
                    stClass = 'bg-yellow-100 text-yellow-700 border-yellow-200'; stText = '–í —Ä–æ–±–æ—Ç—ñ'; 
                }

                div.innerHTML = `
                    <div class="flex justify-between text-xs text-gray-400 font-bold mb-1">
                        <span>#${item.id} ‚Ä¢ ${item.date}</span>
                        <span class="${stClass} px-2 py-0.5 rounded border uppercase">${stText}</span>
                    </div>
                    <div class="font-bold text-sm text-gray-800">${item.title}</div>
                `;
                list.appendChild(div);
            });
        }

        function syncHistory() {
             const email = localStorage.getItem('emet_email');
             if(email) loadHistoryFromServer(email);
        }

        // --- 5. –§–û–†–ú–ê ---
        function renderDynamicForm() {
            const p = document.getElementById('product').value;
            const t = document.getElementById('claimType').value;
            const c = document.getElementById('dynamic-form-area');
            const f = document.getElementById('dynamic-fields');
            
            f.innerHTML = '';
            
            if(!t || !p){ c.classList.add('hidden'); return; }
            c.classList.remove('hidden');
            
            const medicalTypes = ['side_effect','complication','effectiveness'];
            
            if(medicalTypes.includes(t) && FORMS_CONFIG[p]) {
                document.querySelector('#dynamic-form-area h3').innerHTML = '<i class="fa-solid fa-user-doctor mr-1"></i>–ú–µ–¥–∏—á–Ω–∞ –∞–Ω–∫–µ—Ç–∞';
                FORMS_CONFIG[p].forEach(x => {
                    let h = `<div><label class="block text-xs font-medium text-gray-600 mb-1">${x.label}</label>`;
                    if(x.type === 'textarea') 
                        h += `<textarea id="cust_${x.id}" rows="2" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none"></textarea>`;
                    else if(x.type === 'select') 
                        h += `<select id="cust_${x.id}" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">${x.options.map(o=>`<option>${o}</option>`).join('')}</select>`;
                    else 
                        h += `<input type="${x.type}" id="cust_${x.id}" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none">`;
                    f.insertAdjacentHTML('beforeend', h + '</div>');
                });
            } else {
                document.querySelector('#dynamic-form-area h3').innerHTML = '<i class="fa-solid fa-box-open mr-1"></i>–î–µ—Ç–∞–ª—ñ —ñ–Ω—Ü–∏–¥–µ–Ω—Ç—É';
                const lbl = t === 'quality' ? '–û–ø–∏—à—ñ—Ç—å —Å—É—Ç—å –Ω–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ —è–∫–æ—Å—Ç—ñ' : '–û–ø–∏—à—ñ—Ç—å —Å—É—Ç—å –ø—Ä–æ–±–ª–µ–º–∏ / –±—Ä–∞–∫—É';
                f.innerHTML = `<div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">${lbl}</label>
                    <textarea id="simple_desc" rows="4" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-1 focus:ring-blue-500 outline-none"></textarea>
                </div>`;
            }
        }

        function previewFiles(){
            const p = document.getElementById('preview-area'); 
            p.innerHTML = '';
            [].forEach.call(document.getElementById('dropzone-file').files, f => {
                const r = new FileReader(); 
                r.onload = e => { 
                    p.innerHTML += `<div class="flex-shrink-0 w-14 h-14 rounded-lg overflow-hidden border border-gray-200 shadow-sm"><img src="${e.target.result}" class="w-full h-full object-cover"></div>`; 
                }; 
                r.readAsDataURL(f);
            });
        }

        function submitForm(e) {
            e.preventDefault();
            const btnT = document.getElementById('btn-text');
            const btnL = document.getElementById('btn-loader');
            btnT.innerText = '–í—ñ–¥–ø—Ä–∞–≤–∫–∞...'; 
            btnL.classList.remove('hidden');

            const prod = document.getElementById('product').value;
            const type = document.getElementById('claimType').value;
            const manager = localStorage.getItem('emet_user') || 'Unknown';
            const email = localStorage.getItem('emet_email') || '';

            let det = {};
            const medTypes = ['side_effect','complication','effectiveness'];
            if(medTypes.includes(type) && FORMS_CONFIG[prod]) {
                FORMS_CONFIG[prod].forEach(x => { 
                    const el = document.getElementById('cust_' + x.id); 
                    if(el?.value) det[x.label] = el.value; 
                });
            } else { 
                const el = document.getElementById('simple_desc'); 
                if(el?.value) det[type === 'quality' ? '–û–ø–∏—Å –Ω–µ–≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ—Å—Ç—ñ' : '–û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏'] = el.value; 
            }

            const fd = new FormData();
            fd.append('type', type);
            fd.append('client', document.getElementById('client').value);
            fd.append('product', prod);
            fd.append('lot', document.getElementById('lot').value);
            fd.append('invoice', document.getElementById('invoice').value);
            fd.append('manager', manager);
            fd.append('manager_email', email);
            fd.append('details', JSON.stringify(det));
            
            const files = document.getElementById('dropzone-file').files;
            for(let i=0; i<files.length; i++) fd.append('files', files[i]);

            fetch('/api/submit_claim', { method: 'POST', body: fd })
            .then(r => { 
                if(!r.ok) throw new Error('Error'); 
                return r.json(); 
            })
            .then(d => {
                alert('‚úÖ –†–µ–∫–ª–∞–º–∞—Ü—ñ—é —É—Å–ø—ñ—à–Ω–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ! ID: ' + d.id);
                document.getElementById('claimForm').reset();
                document.getElementById('preview-area').innerHTML = '';
                document.getElementById('dynamic-form-area').classList.add('hidden');
                
                switchTab('history');
                
                btnT.innerText = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Ä–µ–∫–ª–∞–º–∞—Ü—ñ—é'; 
                btnL.classList.add('hidden');
            })
            .catch(e => { 
                console.error(e); 
                btnT.innerText = '–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏'; 
                btnL.classList.add('hidden'); 
                alert('‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è.'); 
            });
        }

        // --- 6. –ú–û–î–ê–õ–¨–ù–ï –í–Ü–ö–ù–û –Ü –ß–ê–¢ ---
        
        async function openModal(id) {
            // 1. –í—ñ–¥–∫—Ä–∏–≤–∞—î–º–æ –≤—ñ–∫–Ω–æ —ñ —Å—Ç–∞–≤–∏–º–æ "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è..."
            document.getElementById('details-modal').classList.remove('hidden');
            
            document.getElementById('m-id').innerText = `#${id}`;
            document.getElementById('m-type').innerText = '–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...';
            document.getElementById('m-client').innerText = '...';
            document.getElementById('m-product').innerText = '...';
            document.getElementById('m-lot').innerText = '...';
            document.getElementById('m-status-badge').innerText = '...';
            document.getElementById('m-status-badge').className = 'px-3 py-1 rounded-full text-xs font-bold uppercase bg-gray-200 text-gray-500';
            
            // –û—á–∏—â–∞—î–º–æ —Å—Ç–∞—Ä—ñ –¥–µ—Ç–∞–ª—ñ
            const dynamicContent = document.getElementById('m-dynamic-content');
            dynamicContent.innerHTML = ''; 
            document.getElementById('m-dynamic-details').classList.add('hidden');

            // 2. –ü–∞—Ä–∞–ª–µ–ª—å–Ω–æ –≤–∞–Ω—Ç–∞–∂–∏–º–æ: –î–ï–¢–ê–õ–Ü + –ö–û–ú–ï–ù–¢–ê–†–Ü
            const detailsPromise = fetch('/api/get_claim_details', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: parseInt(id)})
            }).then(r => r.json());

            const commentsPromise = fetch('/api/get_comments', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({id: parseInt(id)})
            }).then(r => r.json());

            // --- –û–ë–†–û–ë–ö–ê –î–ï–¢–ê–õ–ï–ô –ó–ê–Ø–í–ö–ò ---
            try {
                const detailsData = await detailsPromise;
                
                if (detailsData.status === 'ok') {
                    const d = detailsData.data;
                    document.getElementById('m-type').innerText = '–†–µ–∫–ª–∞–º–∞—Ü—ñ—è';
                    document.getElementById('m-client').innerText = d.client || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('m-product').innerText = d.product || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ';
                    document.getElementById('m-lot').innerText = d.lot ? `(LOT: ${d.lot})` : '';
                    
                    // –°—Ç–∞—Ç—É—Å
                    const badge = document.getElementById('m-status-badge');
                    badge.innerText = d.status_text;
                    if(d.status_text === '–í–∏—Ä—ñ—à–µ–Ω–æ') badge.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase bg-green-100 text-green-700';
                    else if(d.status_text === '–í—ñ–¥–º–æ–≤–ª–µ–Ω–æ') badge.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase bg-red-100 text-red-700';
                    else if(d.status_text === '–ù–æ–≤–∞') badge.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase bg-blue-100 text-blue-700';
                    else badge.className = 'px-3 py-1 rounded-full text-xs font-bold uppercase bg-yellow-100 text-yellow-700';

                    // –ê–Ω–∫–µ—Ç–∞
                    if (d.details) {
                        document.getElementById('m-dynamic-details').classList.remove('hidden');
                        let formattedHTML = d.details.replace(/\n/g, '<br>');
                        dynamicContent.innerHTML = formattedHTML;
                    }
                }
            } catch (e) {
                console.error("Error loading details", e);
                document.getElementById('m-type').innerText = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
            }

            // --- –û–ë–†–û–ë–ö–ê –ö–û–ú–ï–ù–¢–ê–†–Ü–í (–ß–ê–¢) ---
            const commList = document.getElementById('m-comments-list');
            const commLoad = document.getElementById('m-comments-loader');
            const noComm = document.getElementById('m-no-comments');
            
            commList.innerHTML = '';
            commLoad.classList.remove('hidden');
            noComm.classList.add('hidden');

            try {
                const commentsData = await commentsPromise;
                const comments = commentsData.comments || [];
                commLoad.classList.add('hidden');

                if (comments.length === 0) {
                    noComm.classList.remove('hidden');
                } else {
                    comments.forEach(com => {
                        const d = new Date(com.date);
                        const dateStr = d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        
                        const isMe = com.author.includes('–ú–µ–Ω–µ–¥–∂–µ—Ä') || com.author.includes(localStorage.getItem('emet_user'));
                        const bgClass = isMe ? 'bg-blue-50 border-blue-100' : 'bg-gray-100 border-gray-200';

                        commList.innerHTML += `
                        <div class="${bgClass} p-3 rounded-lg text-sm border mb-2">
                            <div class="flex justify-between font-bold text-gray-500 mb-1 text-xs uppercase">
                                <span class="flex items-center"><i class="fa-solid fa-user mr-1 text-blue-400"></i>${com.author}</span>
                                <span>${dateStr}</span>
                            </div>
                            <div class="text-gray-800 leading-relaxed">${com.text}</div>
                        </div>`;
                    });
                    commList.scrollTop = commList.scrollHeight;
                }
            } catch (e) {
                commLoad.classList.add('hidden');
            }
        }
        
        function closeModal(){ 
            document.getElementById('details-modal').classList.add('hidden'); 
        }

        async function sendReply() {
            const idText = document.getElementById('m-id').innerText;
            const id = idText.replace('#', '');
            
            const input = document.getElementById('reply-input');
            const btn = document.getElementById('btn-reply');
            const message = input.value.trim();
            const author = localStorage.getItem('emet_user') || '–ú–µ–Ω–µ–¥–∂–µ—Ä';

            if (!message) return;

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            try {
                const response = await fetch('/api/add_comment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: parseInt(id),
                        message: message,
                        author: author
                    })
                });

                const result = await response.json();

                if (result.status === 'ok') {
                    input.value = ''; 
                    openModal(id); 
                } else {
                    alert('–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏: ' + (result.message || 'Unknown error'));
                }

            } catch (error) {
                console.error(error);
                alert('–ü–æ–º–∏–ª–∫–∞ –∑\'—î–¥–Ω–∞–Ω–Ω—è');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-paper-plane"></i>';
            }
        }

        // --- 7. –ù–ê–í–Ü–ì–ê–¶–Ü–Ø ---
        function switchTab(t){
            document.getElementById('tab-new').classList.toggle('hidden', t !== 'new');
            document.getElementById('tab-history').classList.toggle('hidden', t !== 'history');
            
            const navNew = document.getElementById('nav-new');
            const navHist = document.getElementById('nav-history');

            if(t === 'new') {
                navNew.classList.remove('text-gray-400'); navNew.classList.add('text-blue-600');
                navHist.classList.remove('text-blue-600'); navHist.classList.add('text-gray-400');
            } else {
                navHist.classList.remove('text-gray-400'); navHist.classList.add('text-blue-600');
                navNew.classList.remove('text-blue-600'); navNew.classList.add('text-gray-400');
                
                const email = localStorage.getItem('emet_email');
                if(email) loadHistoryFromServer(email);
            }
        }

        // –ó–∞–ø—É—Å–∫ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
        checkAuth();
    </script>
</body>
</html>
